# ========================
# Build ytmusic-api
# ========================
FROM node:22.4.1-alpine AS ytmusic-api-builder
WORKDIR /builder
RUN apk add --no-cache git
RUN git clone --depth=1 https://github.com/ponlponl123/ts-npm-ytmusic-api /builder/ts-npm-ytmusic-api \
    && cd /builder/ts-npm-ytmusic-api \
    && npm install \
    && npm install -g tsup \
    && npm run build \
    && npm prune --production \
    && rm -rf .git

# ========================
# Build the App with Bun
# ========================
FROM oven/bun:1.3.1-alpine AS bun-builder
WORKDIR /pona-builder

# Install only necessary build dependencies
RUN apk add --no-cache python3 make g++

# Copy package files first for better layer caching
COPY package.json package-lock.json* bun.lockb* ./

# Install ALL dependencies (including dev) for building
RUN bun install && rm -f package-lock.json

# Install build dependencies
RUN bun add -d tsup @types/bun typescript

# Copy source code and config files
COPY tsup.config.ts tsconfig.json ./
COPY src ./src
COPY public ./public

# Copy ytmusic-api build
COPY --from=ytmusic-api-builder /builder/ts-npm-ytmusic-api ./node_modules/ytmusic-api

# Build the application
RUN bun run bun:build

# ========================
# Production Dependencies Only
# ========================
FROM oven/bun:1.3.1-alpine AS deps
WORKDIR /deps

# Install only runtime build tools (minimal set)
RUN apk add --no-cache python3 make g++

# Copy package files
COPY package.json ./

# Copy ytmusic-api (production pruned)
COPY --from=ytmusic-api-builder /builder/ts-npm-ytmusic-api ./node_modules/ytmusic-api

# Install ONLY production dependencies
RUN bun install --production

# Aggressive cleanup - remove unnecessary files from node_modules
RUN find ./node_modules -type f \( \
    -name "*.md" -o \
    -name "*.markdown" -o \
    -name "*.txt" -o \
    -name "*.map" -o \
    -name "*.ts" ! -name "*.d.ts" -o \
    -name "LICENSE*" -o \
    -name "LICENCE*" -o \
    -name "CHANGELOG*" -o \
    -name "README*" -o \
    -name "HISTORY*" -o \
    -name "AUTHORS*" -o \
    -name "CONTRIBUTORS*" -o \
    -name ".npmignore" -o \
    -name ".gitignore" -o \
    -name ".editorconfig" -o \
    -name ".eslintrc*" -o \
    -name ".prettierrc*" -o \
    -name "*.spec.js" -o \
    -name "*.test.js" -o \
    -name "*.spec.ts" -o \
    -name "*.test.ts" \
    \) -delete 2>/dev/null || true

# Remove unnecessary directories from node_modules
RUN find ./node_modules -type d \( \
    -name "test" -o \
    -name "tests" -o \
    -name "__tests__" -o \
    -name "spec" -o \
    -name "docs" -o \
    -name "examples" -o \
    -name "example" -o \
    -name ".github" -o \
    -name "coverage" -o \
    -name ".nyc_output" -o \
    -name "benchmark" -o \
    -name "benchmarks" \
    \) -exec rm -rf {} + 2>/dev/null || true

# Remove source maps and typescript sources but keep type definitions
RUN find ./node_modules -name "*.js.map" -delete 2>/dev/null || true
RUN find ./node_modules -name "*.mjs.map" -delete 2>/dev/null || true

# ========================
# Final Image (Minimal)
# ========================
FROM oven/bun:1.3.1-alpine AS runner
WORKDIR /pona

# Install ONLY runtime libraries (no build tools!)
RUN apk add --no-cache libstdc++ ca-certificates

ENV NODE_ENV=production

# Copy only necessary files
COPY --from=deps /deps/node_modules ./node_modules
COPY --from=bun-builder /pona-builder/dist ./dist
COPY --from=bun-builder /pona-builder/public ./dist/public
COPY --from=bun-builder /pona-builder/package.json ./package.json

EXPOSE 3000
ENV PORT=3000

CMD ["bun", "bun:start-reg-shard"]
