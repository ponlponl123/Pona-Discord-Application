services:
  redis-master:
    image: redis:alpine
    hostname: redis-master
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "port 6379" > /etc/redis-config/redis.conf && 
        echo "bind 0.0.0.0" >> /etc/redis-config/redis.conf &&
        echo "appendonly yes" >> /etc/redis-config/redis.conf &&
        echo "protected-mode no" >> /etc/redis-config/redis.conf &&
        redis-server /etc/redis-config/redis.conf --appendonly yes --slave-read-only no'
    volumes:
      - redis_master_data:/data
    ports:
      - '6379:6379'
    networks:
      - redis-network

  redis-replica-1:
    image: redis:alpine
    hostname: redis-replica-1
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "port 6380" > /etc/redis-config/redis.conf && 
        echo "bind 0.0.0.0" > /etc/redis-config/redis.conf &&
        echo "appendonly yes" >> /etc/redis-config/redis.conf &&
        echo "protected-mode no" >> /etc/redis-config/redis.conf &&
        redis-server /etc/redis-config/redis.conf --replicaof redis-master 6379 --slave-read-only no'
    volumes:
      - redis_replica_1_data:/data
    ports:
      - '6380:6380'
    networks:
      - redis-network
    depends_on:
      - redis-master

  redis-replica-2:
    image: redis:alpine
    hostname: redis-replica-2
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "port 6381" > /etc/redis-config/redis.conf && 
        echo "bind 0.0.0.0" > /etc/redis-config/redis.conf &&
        echo "appendonly yes" >> /etc/redis-config/redis.conf &&
        echo "protected-mode no" >> /etc/redis-config/redis.conf &&
        redis-server /etc/redis-config/redis.conf --replicaof redis-master 6379 --slave-read-only no'
    volumes:
      - redis_replica_2_data:/data
    ports:
      - '6381:6381'
    networks:
      - redis-network
    depends_on:
      - redis-master

  redis-sentinel-1:
    image: redis:alpine
    hostname: redis-sentinel-1
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "bind 0.0.0.0" > /etc/redis-config/sentinel.conf &&
        echo "port 26379" >> /etc/redis-config/sentinel.conf && 
        echo "sentinel monitor pona_master redis-master 6379 2" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel resolve-hostnames yes" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel down-after-milliseconds pona_master 30000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel failover-timeout pona_master 180000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel parallel-syncs pona_master 1" >> /etc/redis-config/sentinel.conf &&
        redis-server /etc/redis-config/sentinel.conf --sentinel'
    ports:
      - '26379:26379'
    networks:
      - redis-network
    environment:
      - TILT_MODE=no
    depends_on:
      - redis-master
      - redis-replica-1
      - redis-replica-2

  redis-sentinel-2:
    image: redis:alpine
    hostname: redis-sentinel-2
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "bind 0.0.0.0" > /etc/redis-config/sentinel.conf &&
        echo "port 26380" >> /etc/redis-config/sentinel.conf && 
        echo "sentinel monitor pona_master redis-master 6379 2" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel resolve-hostnames yes" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel down-after-milliseconds pona_master 30000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel failover-timeout pona_master 180000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel parallel-syncs pona_master 1" >> /etc/redis-config/sentinel.conf &&
        redis-server /etc/redis-config/sentinel.conf --sentinel'
    ports:
      - '26380:26380'
    networks:
      - redis-network
    environment:
      - TILT_MODE=no
    depends_on:
      - redis-master
      - redis-replica-1
      - redis-replica-2

  redis-sentinel-3:
    image: redis:alpine
    hostname: redis-sentinel-3
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "bind 0.0.0.0" > /etc/redis-config/sentinel.conf &&
        echo "port 26381" >> /etc/redis-config/sentinel.conf && 
        echo "sentinel monitor pona_master redis-master 6379 2" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel resolve-hostnames yes" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel down-after-milliseconds pona_master 30000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel failover-timeout pona_master 180000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel parallel-syncs pona_master 1" >> /etc/redis-config/sentinel.conf &&
        redis-server /etc/redis-config/sentinel.conf --sentinel'
    ports:
      - '26381:26381'
    networks:
      - redis-network
    environment:
      - TILT_MODE=no
    depends_on:
      - redis-master
      - redis-replica-1
      - redis-replica-2

networks:
  redis-network:
    name: redis-network
    driver: bridge

volumes:
  redis_master_data:
  redis_replica_1_data:
  redis_replica_2_data:
