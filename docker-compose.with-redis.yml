services:
  redis-master:
    image: redis:alpine
    hostname: redis-master
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "port 6379" > /etc/redis-config/redis.conf && 
        echo "bind 0.0.0.0" > /etc/redis-config/redis.conf &&
        echo "appendonly yes" >> /etc/redis-config/redis.conf &&
        echo "protected-mode no" >> /etc/redis-config/redis.conf &&
        redis-server /etc/redis-config/redis.conf --appendonly yes --slave-read-only no'
    volumes:
      - redis_master_data:/data
    ports:
      - "6379:6379"
    networks:
      - redis-network
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == manager]

  redis-replica:
    image: redis:alpine
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "port 6380" > /etc/redis-config/redis.conf && 
        echo "bind 0.0.0.0" > /etc/redis-config/redis.conf &&
        echo "appendonly yes" >> /etc/redis-config/redis.conf &&
        echo "protected-mode no" >> /etc/redis-config/redis.conf &&
        redis-server /etc/redis-config/redis.conf --replicaof redis-master 6379 --slave-read-only no'
    volumes:
      - redis_replica_data:/data
    ports:
      - "6380:6380"
    networks:
      - redis-network
    deploy:
      replicas: 2
    depends_on:
      - redis-master

  redis-sentinel:
    image: redis:alpine
    command: >
      sh -c 'mkdir -p /etc/redis-config &&
        echo "bind 0.0.0.0" > /etc/redis-config/sentinel.conf &&
        echo "port 26379" > /etc/redis-config/sentinel.conf && 
        echo "sentinel monitor pona_master redis-master 6379 2" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel resolve-hostnames yes" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel down-after-milliseconds pona_master 30000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel failover-timeout pona_master 180000" >> /etc/redis-config/sentinel.conf &&
        echo "sentinel parallel-syncs pona_master 1" >> /etc/redis-config/sentinel.conf &&
        redis-server /etc/redis-config/sentinel.conf --sentinel'
    ports:
      - "26379:26379"
    networks:
      - redis-network
    environment:
      - TILT_MODE=no
    deploy:
      replicas: 3
    depends_on:
      - redis-master
      - redis-replica
  
  lavalink:
    # pin the image version to Lavalink v4
    image: ghcr.io/lavalink-devs/lavalink:4
    container_name: lavalink
    restart: unless-stopped
    environment:
      # set Java options here
      - _JAVA_OPTIONS=-Xmx6G
      # set lavalink server port
      - SERVER_PORT=2333
      # set password for lavalink
      - LAVALINK_SERVER_PASSWORD=youshallnotpass
    volumes:
      # mount application.yml from the same directory or use environment variables
      - ./lavalink/application.yml:/opt/Lavalink/application.yml
      # persist plugins between restarts, make sure to set the correct permissions (user: 322, group: 322)
      - ./lavalink/plugins/:/opt/Lavalink/plugins/
    networks:
      - lavalink
    expose:
      # lavalink exposes port 2333 to connect to for other containers (this is for documentation purposes only)
      - 2333
    ports:
      # you only need this if you want to make your lavalink accessible from outside of containers
      - "2333:2333"
  pona:
    build: .
    container_name: pona
    volumes:
      - ./.env.production:/pona/.env.production
      - ./ponaState/:/pona/ponaState/
    environment:
      # ... other environment variables
      REDIS_ENABLED: true
      LAVALINK_SERVER: lavalink  # Use the service name "lavalink" instead of localhost
    expose:
      - 3000
    networks:
      - lavalink
      - socketio-network
    ports:
      - "3000:3000"
    depends_on:
      - lavalink
      - redis-master
      - redis-replica
      - redis-sentinel
volumes:
  redis_master_data:
  redis_replica_data:
networks:
  # create a lavalink network you can add other containers to, to give them access to Lavalink
  lavalink:
    name: lavalink
  pona:
    name: socketio-network
  redis-network:
    name: redis-network
    driver: overlay